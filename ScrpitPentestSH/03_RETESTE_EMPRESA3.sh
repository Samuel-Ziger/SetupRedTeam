#!/bin/bash

################################################################################
# SCRIPT DE RETESTE - Pentesting
# Data: 28/11/2025
# Analista: Samuel Ziger
# Objetivo: Validar corre√ß√£o de vulnerabilidades OpenSSH e WordPress
################################################################################

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Solicitar informa√ß√µes do alvo
echo -e "${BLUE}=================================${NC}"
echo -e "${BLUE}SCRIPT DE RETESTE - Pentesting${NC}"
echo -e "${BLUE}=================================${NC}\n"

read -p "Digite o dom√≠nio principal (ex: exemplo.com.br): " TARGET
read -p "Digite o subdom√≠nio da app (ex: app.exemplo.com.br, ou Enter para usar mesmo dom√≠nio): " TARGET_APP
read -p "Digite o IP do alvo (opcional, pressione Enter para pular): " TARGET_IP

if [ -z "$TARGET" ]; then
    echo -e "${RED}[ERRO] Dom√≠nio √© obrigat√≥rio!${NC}"
    exit 1
fi

[ -z "$TARGET_APP" ] && TARGET_APP="$TARGET"

echo -e "\n${GREEN}Alvo principal: $TARGET${NC}"
echo -e "${GREEN}Alvo app: $TARGET_APP${NC}"
[ ! -z "$TARGET_IP" ] && echo -e "${GREEN}IP: $TARGET_IP${NC}"
echo ""

# Configura√ß√µes
OUTPUT_DIR="./resultados_${TARGET//./_}_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$OUTPUT_DIR"

# Log de execu√ß√£o
LOG_FILE="$OUTPUT_DIR/execution.log"
exec > >(tee -a "$LOG_FILE") 2>&1

echo -e "${BLUE}=================================${NC}"
echo -e "${BLUE}RETESTE: $TARGET${NC}"
echo -e "${BLUE}Data: $(date)${NC}"
echo -e "${BLUE}=================================${NC}\n"

################################################################################
# FUN√á√ÉO: Banner de se√ß√£o
################################################################################
print_section() {
    echo -e "\n${GREEN}[$(date +%H:%M:%S)] ========== $1 ==========${NC}\n"
}

################################################################################
# TESTE 3.1: OpenSSH 10.0p2 com CVEs (CR√çTICO)
################################################################################
print_section "TESTE 3.1: Verificando OpenSSH (CVE-2025-61985, CVE-2025-61984)"

echo "# Verificando vers√£o do OpenSSH..."
nmap -sV -p 22 "$TARGET_IP" -oN "$OUTPUT_DIR/3.1_ssh_version.txt"

echo -e "\n## Resultado do scan:"
cat "$OUTPUT_DIR/3.1_ssh_version.txt"

# Extrair vers√£o
SSH_VERSION=$(grep "22/tcp.*ssh" "$OUTPUT_DIR/3.1_ssh_version.txt" | grep -oP "OpenSSH \K[\d\.]+p?\d*")

echo -e "\n## Vers√£o detectada: ${BLUE}$SSH_VERSION${NC}"

if [[ "$SSH_VERSION" == "10.0p2" ]]; then
    echo -e "${RED}[REPROVADO] OpenSSH 10.0p2 ainda em uso (vulner√°vel)${NC}"
else
    echo -e "${GREEN}[APROVADO] OpenSSH atualizado para: $SSH_VERSION${NC}"
fi

echo -e "\n# Executando script vulners para CVE checking..."
nmap -p 22 --script ssh2-enum-algos,vulners "$TARGET_IP" -oN "$OUTPUT_DIR/3.1_ssh_vulners.txt"

echo -e "\n## Procurando por CVEs no resultado..."
grep -i "CVE-" "$OUTPUT_DIR/3.1_ssh_vulners.txt" > "$OUTPUT_DIR/3.1_cves_found.txt"

if [ -s "$OUTPUT_DIR/3.1_cves_found.txt" ]; then
    echo -e "${RED}[ALERTA] CVEs encontradas:${NC}"
    cat "$OUTPUT_DIR/3.1_cves_found.txt"
else
    echo -e "${GREEN}[APROVADO] Nenhuma CVE detectada pelo vulners${NC}"
fi

echo -e "\n# Testando conectividade SSH..."
timeout 5 nc -vz "$TARGET_IP" 22 2>&1 | tee "$OUTPUT_DIR/3.1_ssh_connectivity.txt"

if grep -q "succeeded" "$OUTPUT_DIR/3.1_ssh_connectivity.txt"; then
    echo -e "${YELLOW}[INFO] Porta 22 acess√≠vel - verificar se h√° firewall/whitelist${NC}"
    
    echo -e "\n## Testando autentica√ß√£o por senha (deve estar desabilitada)..."
    timeout 5 ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no \
        test@"$TARGET_IP" 2>&1 | tee "$OUTPUT_DIR/3.1_ssh_password_test.txt"
    
    if grep -qi "permission denied\|password:" "$OUTPUT_DIR/3.1_ssh_password_test.txt"; then
        echo -e "${YELLOW}[ALERTA] Autentica√ß√£o por senha pode estar ativa!${NC}"
    else
        echo -e "${GREEN}[OK] Autentica√ß√£o por senha desabilitada${NC}"
    fi
else
    echo -e "${GREEN}[APROVADO] Porta 22 bloqueada por firewall${NC}"
fi

################################################################################
# TESTE 3.2: Arquivo wp-app.log Exposto (ALTO)
################################################################################
print_section "TESTE 3.2: Verificando Arquivo wp-app.log Exposto"

echo "# Testando acesso direto ao log..."

# Testar m√∫ltiplos paths poss√≠veis
PATHS=(
    "https://${TARGET}/wp-app.log"
    "https://${TARGET_APP}/wp-app.log"
    "https://${TARGET_APP}/wordpress/wp-app.log"
    "https://${TARGET_APP}/logs/wp-app.log"
    "https://${TARGET_APP}/wp-content/wp-app.log"
)

LOG_FOUND=0

for path in "${PATHS[@]}"; do
    echo "Testando: $path"
    STATUS=$(curl -I -s "$path" 2>&1 | grep "HTTP" | awk '{print $2}' | head -1)
    echo "  Status: $STATUS"
    
    if [[ "$STATUS" == "200" ]]; then
        echo -e "${RED}  [!] LOG ACESS√çVEL EM: $path${NC}"
        ((LOG_FOUND++))
        
        # Baixar primeiras linhas
        curl -s "$path" | head -20 > "$OUTPUT_DIR/3.2_log_sample_$(basename $path).txt"
    elif [[ "$STATUS" == "403" ]]; then
        echo -e "${YELLOW}  [~] Arquivo existe mas acesso negado (403)${NC}"
    elif [[ "$STATUS" == "404" ]]; then
        echo -e "${GREEN}  [OK] Arquivo n√£o encontrado (404)${NC}"
    fi
done

echo -e "\n## Resultado:"
if [ $LOG_FOUND -gt 0 ]; then
    echo -e "${RED}[REPROVADO] Log acess√≠vel em $LOG_FOUND localiza√ß√£o(√µes)${NC}"
else
    echo -e "${GREEN}[APROVADO] Log n√£o acess√≠vel publicamente${NC}"
fi

echo -e "\n# Tentando enumerar outros arquivos .log com gobuster..."
gobuster dir -u "https://${TARGET_APP}/" \
    -w /usr/share/wordlists/dirb/common.txt \
    -x log,txt \
    -t 20 \
    -q \
    --wildcard \
    -o "$OUTPUT_DIR/3.2_gobuster_logs.txt" 2>&1 || echo "Gobuster conclu√≠do (ou erro)"

if [ -s "$OUTPUT_DIR/3.2_gobuster_logs.txt" ]; then
    echo -e "\n## Arquivos .log/.txt encontrados:"
    cat "$OUTPUT_DIR/3.2_gobuster_logs.txt"
fi

################################################################################
# TESTE 3.3: Compress√£o HTTP (BREACH Risk) (M√âDIO)
################################################################################
print_section "TESTE 3.3: Verificando Compress√£o em Endpoints Sens√≠veis"

echo "# Testando wp-login.php..."
curl -H "Accept-Encoding: gzip, deflate" \
    -I "https://${TARGET_APP}/wp-login.php" \
    2>&1 | tee "$OUTPUT_DIR/3.3_wplogin_headers.txt" | grep -i "content-encoding"

if grep -qi "content-encoding" "$OUTPUT_DIR/3.3_wplogin_headers.txt"; then
    ENCODING=$(grep -i "content-encoding" "$OUTPUT_DIR/3.3_wplogin_headers.txt" | cut -d: -f2)
    echo -e "${RED}[REPROVADO] wp-login.php com compress√£o: $ENCODING${NC}"
else
    echo -e "${GREEN}[APROVADO] wp-login.php sem compress√£o${NC}"
fi

echo -e "\n# Testando wp-admin/..."
curl -H "Accept-Encoding: gzip, deflate" \
    -I "https://${TARGET_APP}/wp-admin/" \
    2>&1 | tee "$OUTPUT_DIR/3.3_wpadmin_headers.txt" | grep -i "content-encoding"

if grep -qi "content-encoding" "$OUTPUT_DIR/3.3_wpadmin_headers.txt"; then
    ENCODING=$(grep -i "content-encoding" "$OUTPUT_DIR/3.3_wpadmin_headers.txt" | cut -d: -f2)
    echo -e "${RED}[REPROVADO] wp-admin com compress√£o: $ENCODING${NC}"
else
    echo -e "${GREEN}[APROVADO] wp-admin sem compress√£o${NC}"
fi

################################################################################
# TESTE 3.4: Headers Anti-Clickjacking Ausentes (M√âDIO)
################################################################################
print_section "TESTE 3.4: Verificando Headers Anti-Clickjacking"

echo "# Capturando headers de seguran√ßa..."
curl -I "https://${TARGET_APP}/" 2>&1 | tee "$OUTPUT_DIR/3.4_security_headers.txt"

echo -e "\n## Verificando X-Frame-Options..."
if grep -qi "x-frame-options" "$OUTPUT_DIR/3.4_security_headers.txt"; then
    XFO=$(grep -i "x-frame-options" "$OUTPUT_DIR/3.4_security_headers.txt")
    echo -e "${GREEN}[APROVADO] X-Frame-Options presente: $XFO${NC}"
else
    echo -e "${RED}[REPROVADO] X-Frame-Options AUSENTE${NC}"
fi

echo -e "\n## Verificando Content-Security-Policy (frame-ancestors)..."
if grep -qi "content-security-policy.*frame-ancestors" "$OUTPUT_DIR/3.4_security_headers.txt"; then
    CSP=$(grep -i "content-security-policy" "$OUTPUT_DIR/3.4_security_headers.txt" | grep -i "frame-ancestors")
    echo -e "${GREEN}[APROVADO] CSP frame-ancestors presente: $CSP${NC}"
elif grep -qi "content-security-policy" "$OUTPUT_DIR/3.4_security_headers.txt"; then
    echo -e "${YELLOW}[PARCIAL] CSP presente mas sem frame-ancestors${NC}"
    grep -i "content-security-policy" "$OUTPUT_DIR/3.4_security_headers.txt"
else
    echo -e "${RED}[REPROVADO] Content-Security-Policy AUSENTE${NC}"
fi

echo -e "\n## Outros headers de seguran√ßa:"
echo "Strict-Transport-Security:"
grep -i "strict-transport-security" "$OUTPUT_DIR/3.4_security_headers.txt" || echo "  [AUSENTE]"

echo "X-Content-Type-Options:"
grep -i "x-content-type-options" "$OUTPUT_DIR/3.4_security_headers.txt" || echo "  [AUSENTE]"

echo "Referrer-Policy:"
grep -i "referrer-policy" "$OUTPUT_DIR/3.4_security_headers.txt" || echo "  [AUSENTE]"

################################################################################
# TESTE ADICIONAL: Verificar Vers√£o do WordPress
################################################################################
print_section "TESTE ADICIONAL: Verificando Vers√£o do WordPress"

echo "# Buscando meta generator..."
curl -s "https://${TARGET_APP}/" | grep -i "generator" > "$OUTPUT_DIR/3.5_wp_version.txt"

if [ -s "$OUTPUT_DIR/3.5_wp_version.txt" ]; then
    echo "Vers√£o encontrada:"
    cat "$OUTPUT_DIR/3.5_wp_version.txt"
    
    WP_VERSION=$(grep -oP 'WordPress \K[\d\.]+' "$OUTPUT_DIR/3.5_wp_version.txt")
    echo -e "\n${BLUE}WordPress: $WP_VERSION${NC}"
else
    echo "Meta generator n√£o encontrado (pode estar oculto - bom sinal)"
fi

echo -e "\n# Verificando readme.html..."
curl -I "https://${TARGET_APP}/readme.html" 2>&1 | tee "$OUTPUT_DIR/3.5_readme.txt" | grep "HTTP"

if grep -q "200 OK" "$OUTPUT_DIR/3.5_readme.txt"; then
    echo -e "${YELLOW}[ALERTA] readme.html acess√≠vel (exp√µe vers√£o WP)${NC}"
else
    echo -e "${GREEN}[OK] readme.html n√£o acess√≠vel${NC}"
fi

################################################################################
# RELAT√ìRIO FINAL
################################################################################
print_section "RELAT√ìRIO CONSOLIDADO"

cat > "$OUTPUT_DIR/RELATORIO_RESUMO.md" << EOF
# Relat√≥rio de Reteste - $TARGET_GEN√âRICO
**Data:** $(date)
**Analista:** Samuel Ziger
**Dom√≠nio Principal:** $TARGET
**Dom√≠nio App:** $TARGET_APP
**IP:** ${TARGET_IP:-N/A}

## Resumo Executivo

| # | Vulnerabilidade | Severidade | Status | Observa√ß√µes |
|---|-----------------|------------|--------|-------------|
| 3.1 | OpenSSH 10.0p2 com CVEs | üî¥ CR√çTICO | [ ] | Ver 3.1_*.txt |
| 3.2 | Arquivo wp-app.log Exposto | üî¥ ALTO | [ ] | Ver 3.2_*.txt |
| 3.3 | Compress√£o HTTP (BREACH) | üîµ M√âDIO | [ ] | Ver 3.3_*.txt |
| 3.4 | Headers Anti-Clickjacking | üîµ M√âDIO | [ ] | Ver 3.4_*.txt |

## Verifica√ß√µes Adicionais

- Vers√£o do WordPress: [Ver 3.5_wp_version.txt]
- readme.html exposto: [Ver 3.5_readme.txt]
- Arquivos .log adicionais: [Ver 3.2_gobuster_logs.txt]

## Checklist de Hardening SSH

- [ ] OpenSSH atualizado para vers√£o >= 10.1
- [ ] Porta 22 restrita por firewall (apenas IPs autorizados)
- [ ] PasswordAuthentication no
- [ ] PermitRootLogin no
- [ ] fail2ban instalado e ativo
- [ ] Chaves SSH rotacionadas (se comprometidas)

## Checklist de Hardening WordPress

- [ ] wp-app.log movido para fora do webroot
- [ ] readme.html removido
- [ ] wp-admin protegido (rate-limit, IP whitelist, ou 2FA)
- [ ] Headers de seguran√ßa implementados
- [ ] Compress√£o desabilitada em endpoints sens√≠veis
- [ ] WordPress, plugins e temas atualizados

## Arquivos de Evid√™ncia

Todos os outputs foram salvos em: \`$OUTPUT_DIR/\`

## Pr√≥ximos Passos

1. Revisar manualmente todos os arquivos .txt gerados
2. Preencher coluna "Status" da tabela acima
3. Executar WPScan completo (se necess√°rio)
4. Gerar relat√≥rio executivo para o cliente

EOF

cat "$OUTPUT_DIR/RELATORIO_RESUMO.md"

echo -e "\n${GREEN}=================================${NC}"
echo -e "${GREEN}RETESTE CONCLU√çDO!${NC}"
echo -e "${GREEN}=================================${NC}"
echo -e "\nResultados salvos em: ${BLUE}$OUTPUT_DIR${NC}"
echo -e "Relat√≥rio resumido: ${BLUE}$OUTPUT_DIR/RELATORIO_RESUMO.md${NC}"
echo -e "Log de execu√ß√£o: ${BLUE}$LOG_FILE${NC}\n"

echo -e "${YELLOW}RECOMENDA√á√ÉO:${NC} Execute WPScan para an√°lise completa de plugins:"
echo -e "${BLUE}wpscan --url https://${TARGET_APP} --enumerate vp,vt,u --api-token YOUR_TOKEN${NC}\n"
