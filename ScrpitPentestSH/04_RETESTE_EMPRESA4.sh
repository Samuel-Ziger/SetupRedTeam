#!/bin/bash

################################################################################
# SCRIPT DE RETESTE - Pentesting
# Data: 28/11/2025
# Analista: Samuel Ziger
# Objetivo: Validar correÃ§Ã£o de vulnerabilidades crÃ­ticas de arquivos expostos
################################################################################

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Solicitar informaÃ§Ãµes do alvo
echo -e "${BLUE}=================================${NC}"
echo -e "${BLUE}SCRIPT DE RETESTE - Pentesting${NC}"
echo -e "${BLUE}=================================${NC}\n"

read -p "Digite o domÃ­nio alvo (ex: exemplo.com): " TARGET_DOMAIN
read -p "Digite o IP principal do alvo: " TARGET_IP
read -p "Digite o IP SSH (ou Enter se for o mesmo): " TARGET_IP_SSH

if [ -z "$TARGET_DOMAIN" ] || [ -z "$TARGET_IP" ]; then
    echo -e "${RED}[ERRO] DomÃ­nio e IP principal sÃ£o obrigatÃ³rios!${NC}"
    exit 1
fi

[ -z "$TARGET_IP_SSH" ] && TARGET_IP_SSH="$TARGET_IP"

echo -e "\n${GREEN}DomÃ­nio: $TARGET_DOMAIN${NC}"
echo -e "${GREEN}IP Principal: $TARGET_IP${NC}"
echo -e "${GREEN}IP SSH: $TARGET_IP_SSH${NC}"
echo ""

# ConfiguraÃ§Ãµes
OUTPUT_DIR="./resultados_${TARGET_DOMAIN//./_}_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$OUTPUT_DIR"

# Log de execuÃ§Ã£o
LOG_FILE="$OUTPUT_DIR/execution.log"
exec > >(tee -a "$LOG_FILE") 2>&1

echo -e "${BLUE}=================================${NC}"
echo -e "${BLUE}RETESTE: $TARGET_DOMAIN ($TARGET_IP)${NC}"
echo -e "${BLUE}Data: $(date)${NC}"
echo -e "${BLUE}=================================${NC}\n"

################################################################################
# FUNÃ‡ÃƒO: Banner de seÃ§Ã£o
################################################################################
print_section() {
    echo -e "\n${GREEN}[$(date +%H:%M:%S)] ========== $1 ==========${NC}\n"
}

################################################################################
# TESTE 4.1: Arquivos SensÃ­veis Expostos (CRÃTICO)
################################################################################
print_section "TESTE 4.1: Verificando Arquivos/DiretÃ³rios SensÃ­veis Expostos"

# Lista de arquivos/diretÃ³rios crÃ­ticos
SENSITIVE_PATHS=(
    "/.mysql_history"
    "/.ssh/"
    "/.ssh/id_rsa"
    "/.ssh/authorized_keys"
    "/.bash_history"
    "/_backup/"
    "/_db_backups/"
    "/.git/config"
    "/.git/HEAD"
    "/.env"
    "/backup.sql"
    "/database.sql"
    "/db_backup.tar.gz"
)

echo "# Testando acesso a arquivos/diretÃ³rios sensÃ­veis..."
echo "Base URL: http://${TARGET_IP}"

FOUND_COUNT=0

for path in "${SENSITIVE_PATHS[@]}"; do
    echo -e "\nTestando: $path"
    
    # Testar HTTP
    STATUS=$(curl -I -s "http://${TARGET_IP}${path}" 2>&1 | grep "HTTP" | awk '{print $2}' | head -1)
    echo "  HTTP Status: $STATUS"
    
    if [[ "$STATUS" == "200" ]]; then
        echo -e "${RED}  [!] ARQUIVO ACESSÃVEL!${NC}"
        ((FOUND_COUNT++))
        
        # Salvar evidÃªncia
        curl -s "http://${TARGET_IP}${path}" | head -30 > "$OUTPUT_DIR/4.1_exposed_$(echo $path | tr '/' '_').txt"
        echo "  EvidÃªncia salva em: 4.1_exposed_$(echo $path | tr '/' '_').txt"
        
    elif [[ "$STATUS" == "403" ]]; then
        echo -e "${YELLOW}  [~] Existe mas acesso negado (403)${NC}"
        ((FOUND_COUNT++))
        
    elif [[ "$STATUS" == "404" ]]; then
        echo -e "${GREEN}  [OK] NÃ£o encontrado (404)${NC}"
        
    elif [[ "$STATUS" == "301" || "$STATUS" == "302" ]]; then
        echo -e "${YELLOW}  [~] Redirecionamento ($STATUS)${NC}"
        
    else
        echo -e "${BLUE}  [?] Status inesperado: $STATUS${NC}"
    fi
done

echo -e "\n## RESUMO:"
if [ $FOUND_COUNT -eq 0 ]; then
    echo -e "${GREEN}[APROVADO] Nenhum arquivo sensÃ­vel acessÃ­vel${NC}"
else
    echo -e "${RED}[REPROVADO] $FOUND_COUNT arquivo(s)/diretÃ³rio(s) exposto(s) ou protegido(s) com 403${NC}"
fi

################################################################################
# TESTE 4.1.2: Gobuster - Busca Extensiva
################################################################################
print_section "TESTE 4.1.2: EnumeraÃ§Ã£o com Gobuster (Arquivos de Backup)"

echo "# Executando Gobuster para buscar backups e arquivos sensÃ­veis..."

gobuster dir -u "http://${TARGET_IP}/" \
    -w /usr/share/wordlists/dirb/common.txt \
    -x sql,bak,backup,old,tar,gz,zip,log,txt,env \
    -t 30 \
    -q \
    -b 404 \
    -o "$OUTPUT_DIR/4.1.2_gobuster_backups.txt" 2>&1 || echo "Gobuster finalizado"

echo -e "\n## Resultados:"
if [ -s "$OUTPUT_DIR/4.1.2_gobuster_backups.txt" ]; then
    echo -e "${YELLOW}[ALERTA] Arquivos encontrados:${NC}"
    cat "$OUTPUT_DIR/4.1.2_gobuster_backups.txt"
else
    echo -e "${GREEN}[OK] Nenhum arquivo de backup/sensÃ­vel encontrado${NC}"
fi

################################################################################
# TESTE 4.2: Porta 3000 (Next.js Dev) Exposta (ALTO)
################################################################################
print_section "TESTE 4.2: Verificando Porta 3000 (Next.js Development)"

echo "# Executando Nmap na porta 3000..."
nmap -sV -p 3000 "$TARGET_IP" -oN "$OUTPUT_DIR/4.2_nmap_port3000.txt"

echo -e "\n## Resultado:"
cat "$OUTPUT_DIR/4.2_nmap_port3000.txt"

PORT_STATUS=$(grep "3000/tcp" "$OUTPUT_DIR/4.2_nmap_port3000.txt" | awk '{print $2}')

echo -e "\nStatus da porta 3000: ${BLUE}$PORT_STATUS${NC}"

if [[ "$PORT_STATUS" == "open" ]]; then
    echo -e "${RED}[REPROVADO] Porta 3000 ABERTA!${NC}"
    
    echo -e "\n## Testando conectividade HTTP..."
    curl -I --connect-timeout 5 "http://${TARGET_IP}:3000/" 2>&1 | tee "$OUTPUT_DIR/4.2_http_port3000.txt"
    
elif [[ "$PORT_STATUS" == "filtered" ]]; then
    echo -e "${YELLOW}[PARCIAL] Porta 3000 FILTRADA (firewall ativo)${NC}"
    
elif [[ "$PORT_STATUS" == "closed" ]]; then
    echo -e "${GREEN}[APROVADO] Porta 3000 FECHADA${NC}"
    
else
    echo -e "${BLUE}[INFO] Porta 3000 em estado: $PORT_STATUS${NC}"
fi

echo -e "\n## Testando outras portas de desenvolvimento (3001-3010, 8000-8100)..."
nmap -p 3000-3010,8000-8100 --open "$TARGET_IP" -oN "$OUTPUT_DIR/4.2_nmap_dev_ports.txt"

if grep -q "open" "$OUTPUT_DIR/4.2_nmap_dev_ports.txt"; then
    echo -e "${YELLOW}[ALERTA] Portas de desenvolvimento abertas:${NC}"
    grep "open" "$OUTPUT_DIR/4.2_nmap_dev_ports.txt"
else
    echo -e "${GREEN}[OK] Nenhuma porta de desenvolvimento aberta${NC}"
fi

################################################################################
# TESTE 4.3: SSH Exposto (192.168.0.100:22) (ALTO)
################################################################################
print_section "TESTE 4.3: Verificando SSH (${TARGET_IP_SSH}:22)"

echo "# Verificando acessibilidade da porta 22..."
timeout 5 nc -vz "$TARGET_IP_SSH" 22 2>&1 | tee "$OUTPUT_DIR/4.3_ssh_connectivity.txt"

if grep -q "succeeded\|open" "$OUTPUT_DIR/4.3_ssh_connectivity.txt"; then
    echo -e "${YELLOW}[ALERTA] Porta 22 ACESSÃVEL em ${TARGET_IP_SSH}${NC}"
    
    echo -e "\n## Executando Nmap para verificar versÃ£o SSH..."
    nmap -sV -p 22 "$TARGET_IP_SSH" -oN "$OUTPUT_DIR/4.3_ssh_version.txt"
    cat "$OUTPUT_DIR/4.3_ssh_version.txt"
    
    echo -e "\n## Verificando algoritmos SSH..."
    nmap -p 22 --script ssh2-enum-algos "$TARGET_IP_SSH" -oN "$OUTPUT_DIR/4.3_ssh_algos.txt"
    
    echo -e "\n## Testando autenticaÃ§Ã£o por senha (deve estar desabilitada)..."
    timeout 5 ssh -o PreferredAuthentications=password \
        -o PubkeyAuthentication=no \
        -o StrictHostKeyChecking=no \
        test@"$TARGET_IP_SSH" 2>&1 | tee "$OUTPUT_DIR/4.3_ssh_password_test.txt"
    
    if grep -qi "permission denied\|no supported authentication" "$OUTPUT_DIR/4.3_ssh_password_test.txt"; then
        echo -e "${GREEN}[OK] AutenticaÃ§Ã£o por senha desabilitada ou bloqueada${NC}"
    else
        echo -e "${RED}[REPROVADO] PossÃ­vel autenticaÃ§Ã£o por senha ativa${NC}"
    fi
    
else
    echo -e "${GREEN}[APROVADO] Porta 22 BLOQUEADA por firewall${NC}"
fi

################################################################################
# TESTE 4.4: Headers de SeguranÃ§a (ADICIONAL)
################################################################################
print_section "TESTE 4.4: Verificando Headers de SeguranÃ§a HTTP"

echo "# Capturando headers da aplicaÃ§Ã£o web..."
curl -I "http://${TARGET_IP}/" 2>&1 | tee "$OUTPUT_DIR/4.4_http_headers.txt"

echo -e "\n## AnÃ¡lise de Headers de SeguranÃ§a:"

# HSTS
if grep -qi "strict-transport-security" "$OUTPUT_DIR/4.4_http_headers.txt"; then
    echo -e "${GREEN}âœ“ Strict-Transport-Security presente${NC}"
    grep -i "strict-transport-security" "$OUTPUT_DIR/4.4_http_headers.txt"
else
    echo -e "${RED}âœ— Strict-Transport-Security AUSENTE${NC}"
fi

# X-Frame-Options
if grep -qi "x-frame-options" "$OUTPUT_DIR/4.4_http_headers.txt"; then
    echo -e "${GREEN}âœ“ X-Frame-Options presente${NC}"
    grep -i "x-frame-options" "$OUTPUT_DIR/4.4_http_headers.txt"
else
    echo -e "${RED}âœ— X-Frame-Options AUSENTE${NC}"
fi

# CSP
if grep -qi "content-security-policy:" "$OUTPUT_DIR/4.4_http_headers.txt"; then
    echo -e "${GREEN}âœ“ Content-Security-Policy presente${NC}"
    grep -i "content-security-policy:" "$OUTPUT_DIR/4.4_http_headers.txt"
else
    echo -e "${RED}âœ— Content-Security-Policy AUSENTE${NC}"
fi

# X-Content-Type-Options
if grep -qi "x-content-type-options" "$OUTPUT_DIR/4.4_http_headers.txt"; then
    echo -e "${GREEN}âœ“ X-Content-Type-Options presente${NC}"
else
    echo -e "${RED}âœ— X-Content-Type-Options AUSENTE${NC}"
fi

# Referrer-Policy
if grep -qi "referrer-policy" "$OUTPUT_DIR/4.4_http_headers.txt"; then
    echo -e "${GREEN}âœ“ Referrer-Policy presente${NC}"
    grep -i "referrer-policy" "$OUTPUT_DIR/4.4_http_headers.txt"
else
    echo -e "${RED}âœ— Referrer-Policy AUSENTE${NC}"
fi

################################################################################
# TESTE 4.5: Verificar Tecnologia/Stack (ADICIONAL)
################################################################################
print_section "TESTE 4.5: Identificando Tecnologia da AplicaÃ§Ã£o"

echo "# Analisando headers do servidor..."
SERVER_HEADER=$(grep -i "^Server:" "$OUTPUT_DIR/4.4_http_headers.txt" | cut -d: -f2-)
echo "Server: ${BLUE}$SERVER_HEADER${NC}"

echo -e "\n# Verificando tecnologia (Next.js, etc)..."
curl -s "http://${TARGET_IP}/" | head -50 > "$OUTPUT_DIR/4.5_homepage_sample.html"

if grep -qi "next.js\|_next\|__NEXT_DATA__" "$OUTPUT_DIR/4.5_homepage_sample.html"; then
    echo -e "${BLUE}[INFO] Next.js detectado${NC}"
fi

if grep -qi "x-powered-by" "$OUTPUT_DIR/4.4_http_headers.txt"; then
    POWERED_BY=$(grep -i "x-powered-by" "$OUTPUT_DIR/4.4_http_headers.txt" | cut -d: -f2-)
    echo -e "${YELLOW}[ALERTA] X-Powered-By exposto: $POWERED_BY${NC}"
fi

################################################################################
# RELATÃ“RIO FINAL
################################################################################
print_section "RELATÃ“RIO CONSOLIDADO"

cat > "$OUTPUT_DIR/RELATORIO_RESUMO.md" << EOF
# RelatÃ³rio de Reteste - $TARGET_GENÃ‰RICO ($IP_GENÃ‰RICO)
**Data:** $(date)
**Analista:** Samuel Ziger
**DomÃ­nio:** $TARGET_DOMAIN
**IP Principal:** $TARGET_IP
**IP SSH:** $TARGET_IP_SSH

## Resumo Executivo

| # | Vulnerabilidade | Severidade | Status | ObservaÃ§Ãµes |
|---|-----------------|------------|--------|-------------|
| 4.1 | Arquivos SensÃ­veis Expostos | ðŸ”´ CRÃTICO | [ ] | Ver 4.1_*.txt |
| 4.1.2 | Backups/Logs AcessÃ­veis | ðŸ”´ CRÃTICO | [ ] | Ver 4.1.2_*.txt |
| 4.2 | Porta 3000 (Next.js Dev) | ðŸŸ  ALTO | [ ] | Ver 4.2_*.txt |
| 4.3 | SSH Exposto (${TARGET_IP_SSH}) | ðŸŸ  ALTO | [ ] | Ver 4.3_*.txt |
| 4.4 | Headers de SeguranÃ§a | ðŸ”µ MÃ‰DIO | [ ] | Ver 4.4_*.txt |

## Arquivos CrÃ­ticos Testados

Verificados: $(echo "${SENSITIVE_PATHS[@]}" | wc -w) arquivos/diretÃ³rios
- .mysql_history
- .ssh/ e chaves
- .bash_history
- _backup/ e _db_backups/
- .git/
- .env
- Dumps SQL

## Checklist de CorreÃ§Ã£o

### Arquivos SensÃ­veis
- [ ] Remover .mysql_history, .bash_history do webroot
- [ ] Remover diretÃ³rio .ssh/ do webroot
- [ ] Remover/mover _backup/ e _db_backups/
- [ ] Bloquear acesso a .git/ via .htaccess/nginx
- [ ] Remover arquivos .env, dumps SQL

### Porta 3000
- [ ] Fechar porta 3000 no firewall
- [ ] Next.js bind apenas em 127.0.0.1
- [ ] Usar proxy reverso para produÃ§Ã£o

### SSH (${TARGET_IP_SSH})
- [ ] Restringir porta 22 por IP (whitelist)
- [ ] Desabilitar PasswordAuthentication
- [ ] Desabilitar PermitRootLogin
- [ ] Instalar fail2ban

### Headers de SeguranÃ§a
- [ ] Implementar HSTS
- [ ] Implementar X-Frame-Options
- [ ] Implementar CSP
- [ ] Implementar X-Content-Type-Options
- [ ] Implementar Referrer-Policy
- [ ] Remover X-Powered-By

## Arquivos de EvidÃªncia

Todos os outputs foram salvos em: \`$OUTPUT_DIR/\`

## PrÃ³ximos Passos

1. Revisar todos os arquivos .txt gerados
2. Preencher coluna "Status" da tabela
3. Validar correÃ§Ãµes com novo reteste
4. Gerar relatÃ³rio executivo

## IPs Testados

- **AplicaÃ§Ã£o Web:** $TARGET_IP
- **SSH:** $TARGET_IP_SSH
- **DomÃ­nio:** $TARGET_DOMAIN

EOF

cat "$OUTPUT_DIR/RELATORIO_RESUMO.md"

echo -e "\n${GREEN}=================================${NC}"
echo -e "${GREEN}RETESTE CONCLUÃDO!${NC}"
echo -e "${GREEN}=================================${NC}"
echo -e "\nResultados salvos em: ${BLUE}$OUTPUT_DIR${NC}"
echo -e "RelatÃ³rio resumido: ${BLUE}$OUTPUT_DIR/RELATORIO_RESUMO.md${NC}"
echo -e "Log de execuÃ§Ã£o: ${BLUE}$LOG_FILE${NC}\n"

echo -e "${RED}ATENÃ‡ÃƒO:${NC} Se arquivos crÃ­ticos foram encontrados:"
echo -e "  1. ${RED}NÃƒO compartilhe${NC} os arquivos baixados"
echo -e "  2. Notifique IMEDIATAMENTE o cliente"
echo -e "  3. Exclua evidÃªncias apÃ³s gerar relatÃ³rio\n"
