#!/bin/bash

################################################################################
# SCRIPT DE RETESTE - divisaodeelite.com.br
# Data: 28/11/2025
# Analista: Samuel Ziger
# Objetivo: Validar correÃ§Ã£o de vulnerabilidades crÃ­ticas relacionadas ao Bubble.io
################################################################################

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Solicitar informaÃ§Ãµes do alvo
echo -e "${BLUE}=================================${NC}"
echo -e "${BLUE}SCRIPT DE RETESTE - Pentesting${NC}"
echo -e "${BLUE}=================================${NC}\n"

read -p "Digite o domÃ­nio alvo (ex: exemplo.com.br): " TARGET
read -p "Digite o IP do alvo (opcional, pressione Enter para pular): " TARGET_IP

if [ -z "$TARGET" ]; then
    echo -e "${RED}[ERRO] DomÃ­nio Ã© obrigatÃ³rio!${NC}"
    exit 1
fi

echo -e "\n${GREEN}Alvo configurado: $TARGET${NC}"
[ ! -z "$TARGET_IP" ] && echo -e "${GREEN}IP: $TARGET_IP${NC}"
echo ""

# ConfiguraÃ§Ãµes
OUTPUT_DIR="./resultados_${TARGET//./_}_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$OUTPUT_DIR"

# Log de execuÃ§Ã£o
LOG_FILE="$OUTPUT_DIR/execution.log"
exec > >(tee -a "$LOG_FILE") 2>&1

echo -e "${BLUE}=================================${NC}"
echo -e "${BLUE}RETESTE: $TARGET${NC}"
echo -e "${BLUE}Data: $(date)${NC}"
echo -e "${BLUE}=================================${NC}\n"

################################################################################
# FUNÃ‡ÃƒO: Banner de seÃ§Ã£o
################################################################################
print_section() {
    echo -e "\n${GREEN}[$(date +%H:%M:%S)] ========== $1 ==========${NC}\n"
}

################################################################################
# TESTE 2.1: Token bubble_plp_token Exposto (CRÃTICO)
################################################################################
print_section "TESTE 2.1: Verificando Token bubble_plp_token Exposto"

echo "# Baixando homepage..."
curl -s "https://${TARGET}/" -L > "$OUTPUT_DIR/homepage.html"

echo "## Procurando por bubble_plp_token no HTML..."
grep -i "bubble_plp_token" "$OUTPUT_DIR/homepage.html" > "$OUTPUT_DIR/2.1_bubble_token_html.txt"

if [ -s "$OUTPUT_DIR/2.1_bubble_token_html.txt" ]; then
    echo -e "${RED}[REPROVADO] Token bubble_plp_token ainda exposto!${NC}"
    cat "$OUTPUT_DIR/2.1_bubble_token_html.txt"
else
    echo -e "${GREEN}[APROVADO] Token bubble_plp_token nÃ£o encontrado no HTML${NC}"
fi

echo -e "\n## Procurando por window.* tokens em geral..."
grep -oP 'window\.\w+(_token|_key|_secret)' "$OUTPUT_DIR/homepage.html" > "$OUTPUT_DIR/2.1_window_vars.txt"

if [ -s "$OUTPUT_DIR/2.1_window_vars.txt" ]; then
    echo -e "${YELLOW}[ALERTA] VariÃ¡veis window.* encontradas:${NC}"
    cat "$OUTPUT_DIR/2.1_window_vars.txt" | sort -u
else
    echo -e "${GREEN}[OK] Nenhuma variÃ¡vel window.*token/key/secret encontrada${NC}"
fi

echo -e "\n## Extraindo e analisando arquivos JavaScript..."
grep -oP 'src="[^"]*\.js[^"]*"' "$OUTPUT_DIR/homepage.html" | cut -d'"' -f2 > "$OUTPUT_DIR/2.1_js_files.txt"

echo "Arquivos JS encontrados: $(wc -l < $OUTPUT_DIR/2.1_js_files.txt)"

# Analisar primeiros 5 arquivos JS
echo -e "\n## Analisando arquivos JS em busca de tokens..."
head -5 "$OUTPUT_DIR/2.1_js_files.txt" | while read jsurl; do
    # Converter URL relativa em absoluta
    if [[ $jsurl == http* ]]; then
        full_url="$jsurl"
    else
        full_url="https://${TARGET}${jsurl}"
    fi
    
    filename=$(basename "$jsurl" | sed 's/[?&].*//') # Remove query params
    echo "Analisando: $full_url"
    
    curl -s "$full_url" 2>/dev/null > "$OUTPUT_DIR/2.1_js_${filename}"
    
    # Procurar por tokens
    grep -iE "bubble_plp_token|window\.\w+_token" "$OUTPUT_DIR/2.1_js_${filename}" > "$OUTPUT_DIR/2.1_tokens_${filename}.txt"
    
    if [ -s "$OUTPUT_DIR/2.1_tokens_${filename}.txt" ]; then
        echo -e "${RED}  â””â”€ [!] Token encontrado em $filename!${NC}"
        head -3 "$OUTPUT_DIR/2.1_tokens_${filename}.txt"
    else
        echo -e "${GREEN}  â””â”€ [OK] Nenhum token em $filename${NC}"
    fi
done

################################################################################
# TESTE 2.2: Plugin Malicioso Enviando Dados (CRÃTICO)
################################################################################
print_section "TESTE 2.2: Verificando Plugin Malicioso (railway.app)"

echo "# Procurando por requisiÃ§Ãµes para railway.app no HTML..."
grep -i "railway.app" "$OUTPUT_DIR/homepage.html" > "$OUTPUT_DIR/2.2_railway_html.txt"

if [ -s "$OUTPUT_DIR/2.2_railway_html.txt" ]; then
    echo -e "${RED}[REPROVADO] ReferÃªncias a railway.app encontradas no HTML!${NC}"
    cat "$OUTPUT_DIR/2.2_railway_html.txt"
else
    echo -e "${GREEN}[APROVADO] Nenhuma referÃªncia a railway.app no HTML${NC}"
fi

echo -e "\n## Procurando em arquivos JavaScript..."
for jsfile in "$OUTPUT_DIR"/2.1_js_*.js; do
    if [ -f "$jsfile" ]; then
        if grep -q "railway.app" "$jsfile" 2>/dev/null; then
            echo -e "${RED}[REPROVADO] railway.app encontrado em: $(basename $jsfile)${NC}"
            grep --color=always "railway.app" "$jsfile"
        fi
    fi
done

echo -e "\n${YELLOW}[NOTA] Para verificaÃ§Ã£o completa, use DevTools do navegador:${NC}"
echo "  1. Abra https://${TARGET}/ no navegador"
echo "  2. F12 â†’ Network â†’ Filtrar por 'railway'"
echo "  3. Recarregue a pÃ¡gina"
echo "  4. Verifique se hÃ¡ requisiÃ§Ãµes para nc201746529.up.railway.app"

################################################################################
# TESTE 2.3: Endpoint /version-test/api/1.1/init/data Aberto (ALTO)
################################################################################
print_section "TESTE 2.3: Verificando Endpoint /version-test SEM AutenticaÃ§Ã£o"

echo "# Testando acesso ao endpoint init/data..."
curl -s "https://${TARGET}/version-test/api/1.1/init/data?location=https://test.com" \
    2>&1 | tee "$OUTPUT_DIR/2.3_version_test.txt" | jq . 2>/dev/null || cat "$OUTPUT_DIR/2.3_version_test.txt"

# Verificar status code
STATUS=$(curl -I -s "https://${TARGET}/version-test/api/1.1/init/data" 2>&1 | grep "HTTP" | awk '{print $2}' | head -1)

echo -e "\n## Status Code: $STATUS"

if [[ "$STATUS" == "401" || "$STATUS" == "403" ]]; then
    echo -e "${GREEN}[APROVADO] Endpoint requer autenticaÃ§Ã£o (Status: $STATUS)${NC}"
elif [[ "$STATUS" == "404" ]]; then
    echo -e "${GREEN}[APROVADO] Endpoint nÃ£o encontrado (Status: 404)${NC}"
elif [[ "$STATUS" == "200" ]]; then
    echo -e "${RED}[REPROVADO] Endpoint acessÃ­vel sem autenticaÃ§Ã£o!${NC}"
    
    echo -e "\n## Procurando por dados sensÃ­veis na resposta..."
    grep -iE "password|secret|key|token|email|user" "$OUTPUT_DIR/2.3_version_test.txt" > "$OUTPUT_DIR/2.3_sensitive_data.txt"
    
    if [ -s "$OUTPUT_DIR/2.3_sensitive_data.txt" ]; then
        echo -e "${RED}[CRÃTICO] Dados sensÃ­veis encontrados!${NC}"
        cat "$OUTPUT_DIR/2.3_sensitive_data.txt"
    fi
else
    echo -e "${YELLOW}[INDEFINIDO] Status inesperado: $STATUS${NC}"
fi

################################################################################
# TESTE 2.4: Cookies Inseguros (ALTO)
################################################################################
print_section "TESTE 2.4: Verificando Flags de SeguranÃ§a nos Cookies"

echo "# Capturando cookies..."
curl -I "https://${TARGET}/" 2>&1 | tee "$OUTPUT_DIR/2.4_cookies.txt" | grep -i "set-cookie"

echo -e "\n## Analisando flags..."
grep -i "set-cookie" "$OUTPUT_DIR/2.4_cookies.txt" > "$OUTPUT_DIR/2.4_cookies_only.txt"

if [ -s "$OUTPUT_DIR/2.4_cookies_only.txt" ]; then
    ISSUES=0
    
    while IFS= read -r cookie_line; do
        echo -e "\nCookie: $cookie_line"
        
        # HttpOnly
        if echo "$cookie_line" | grep -qi "httponly"; then
            echo -e "${GREEN}  âœ“ HttpOnly presente${NC}"
        else
            echo -e "${RED}  âœ— HttpOnly AUSENTE${NC}"
            ((ISSUES++))
        fi
        
        # Secure
        if echo "$cookie_line" | grep -qi "secure"; then
            echo -e "${GREEN}  âœ“ Secure presente${NC}"
        else
            echo -e "${RED}  âœ— Secure AUSENTE${NC}"
            ((ISSUES++))
        fi
        
        # SameSite
        if echo "$cookie_line" | grep -qi "samesite"; then
            SAMESITE=$(echo "$cookie_line" | grep -oP "samesite=\K\w+" -i)
            echo -e "${GREEN}  âœ“ SameSite=$SAMESITE${NC}"
        else
            echo -e "${RED}  âœ— SameSite AUSENTE${NC}"
            ((ISSUES++))
        fi
    done < "$OUTPUT_DIR/2.4_cookies_only.txt"
    
    if [ $ISSUES -eq 0 ]; then
        echo -e "\n${GREEN}[APROVADO] Todos os cookies possuem flags de seguranÃ§a${NC}"
    else
        echo -e "\n${RED}[REPROVADO] $ISSUES flag(s) de seguranÃ§a ausente(s)${NC}"
    fi
else
    echo -e "${BLUE}[INFO] Nenhum cookie Set-Cookie encontrado na homepage${NC}"
fi

################################################################################
# TESTE 2.5: Scripts sem SRI (Subresource Integrity) (ALTO)
################################################################################
print_section "TESTE 2.5: Verificando SRI em Scripts Externos"

echo "# Extraindo todos os scripts externos..."
grep -E '<script.*src=' "$OUTPUT_DIR/homepage.html" | grep -E 'https?://' > "$OUTPUT_DIR/2.5_external_scripts.txt"

echo "## Scripts externos encontrados: $(wc -l < $OUTPUT_DIR/2.5_external_scripts.txt)"

echo -e "\n## Verificando presenÃ§a de atributo 'integrity'..."
grep -E '<script.*src=' "$OUTPUT_DIR/homepage.html" | grep -E 'https?://' | grep -v 'integrity=' > "$OUTPUT_DIR/2.5_scripts_sem_sri.txt"

if [ -s "$OUTPUT_DIR/2.5_scripts_sem_sri.txt" ]; then
    echo -e "${RED}[REPROVADO] Scripts sem SRI encontrados:${NC}"
    cat "$OUTPUT_DIR/2.5_scripts_sem_sri.txt"
    echo -e "\nTotal: $(wc -l < $OUTPUT_DIR/2.5_scripts_sem_sri.txt) script(s) sem SRI"
else
    echo -e "${GREEN}[APROVADO] Todos os scripts externos possuem SRI${NC}"
fi

echo -e "\n## Exemplos de scripts COM SRI (se houver):"
grep -E '<script.*src=.*integrity=' "$OUTPUT_DIR/homepage.html" | head -3

################################################################################
# TESTE 2.6: CSP Form-Action Ausente (MÃ‰DIO)
################################################################################
print_section "TESTE 2.6: Verificando CSP form-action"

echo "# Capturando headers CSP do service-worker.js..."
curl -I "https://${TARGET}/service-worker.js" 2>&1 | tee "$OUTPUT_DIR/2.6_csp_sw.txt" | grep -i "content-security-policy"

echo -e "\n# Capturando headers CSP da homepage..."
curl -I "https://${TARGET}/" 2>&1 | tee "$OUTPUT_DIR/2.6_csp_home.txt" | grep -i "content-security-policy"

echo -e "\n## Verificando presenÃ§a de 'form-action'..."
CSP_LINE=$(grep -i "content-security-policy:" "$OUTPUT_DIR/2.6_csp_home.txt" | head -1)

if [ -z "$CSP_LINE" ]; then
    echo -e "${YELLOW}[ALERTA] Nenhum CSP encontrado${NC}"
elif echo "$CSP_LINE" | grep -qi "form-action"; then
    echo -e "${GREEN}[APROVADO] CSP possui diretiva form-action${NC}"
    echo "$CSP_LINE" | grep -oP "form-action[^;]*"
else
    echo -e "${RED}[REPROVADO] CSP nÃ£o possui diretiva form-action${NC}"
    echo "CSP atual: $CSP_LINE"
fi

echo -e "\n## Verificando se CSP estÃ¡ em report-only..."
if grep -qi "content-security-policy-report-only" "$OUTPUT_DIR/2.6_csp_home.txt"; then
    echo -e "${RED}[REPROVADO] CSP estÃ¡ em modo report-only${NC}"
else
    echo -e "${GREEN}[OK] CSP estÃ¡ em modo enforce (ou ausente)${NC}"
fi

################################################################################
# TESTE ADICIONAL: Service Worker
################################################################################
print_section "TESTE ADICIONAL: Verificando Service Worker"

echo "# Testando registro de service worker..."
curl -s "https://${TARGET}/service-worker.js" > "$OUTPUT_DIR/2.7_service_worker.js"

if [ -s "$OUTPUT_DIR/2.7_service_worker.js" ]; then
    echo -e "${BLUE}[INFO] Service Worker encontrado${NC}"
    
    # Verificar se hÃ¡ cÃ³digo suspeito
    echo -e "\n## Procurando por padrÃµes suspeitos..."
    grep -iE "fetch\(|eval\(|Function\(|importScripts" "$OUTPUT_DIR/2.7_service_worker.js" > "$OUTPUT_DIR/2.7_sw_suspicious.txt"
    
    if [ -s "$OUTPUT_DIR/2.7_sw_suspicious.txt" ]; then
        echo -e "${YELLOW}[ALERTA] PadrÃµes que requerem revisÃ£o manual:${NC}"
        head -10 "$OUTPUT_DIR/2.7_sw_suspicious.txt"
    else
        echo -e "${GREEN}[OK] Nenhum padrÃ£o suspeito Ã³bvio${NC}"
    fi
else
    echo -e "${BLUE}[INFO] Service Worker nÃ£o encontrado${NC}"
fi

################################################################################
# RELATÃ“RIO FINAL
################################################################################
print_section "RELATÃ“RIO CONSOLIDADO"

cat > "$OUTPUT_DIR/RELATORIO_RESUMO.md" << EOF
# RelatÃ³rio de Reteste - $TARGET
**Data:** $(date)
**Analista:** Samuel Ziger
**DomÃ­nio:** $TARGET
**IP:** ${TARGET_IP:-N/A}

## Resumo Executivo

| # | Vulnerabilidade | Severidade | Status | ObservaÃ§Ãµes |
|---|-----------------|------------|--------|-------------|
| 2.1 | Token bubble_plp_token Exposto | ðŸ”´ CRÃTICO | [ ] | Ver 2.1_*.txt |
| 2.2 | Plugin Malicioso (railway.app) | ðŸ”´ CRÃTICO | [ ] | Ver 2.2_*.txt + Manual |
| 2.3 | Endpoint /version-test Sem Auth | ðŸŸ  ALTO | [ ] | Ver 2.3_*.txt |
| 2.4 | Cookies Inseguros | ðŸŸ  ALTO | [ ] | Ver 2.4_*.txt |
| 2.5 | Scripts sem SRI | ðŸŸ  ALTO | [ ] | Ver 2.5_*.txt |
| 2.6 | CSP form-action Ausente | ðŸ”µ MÃ‰DIO | [ ] | Ver 2.6_*.txt |

## Testes Manuais Pendentes

### Plugin Malicioso (2.2)
**Como testar manualmente:**
1. Abrir https://divisaodeelite.com.br/ no Chrome/Firefox
2. Abrir DevTools (F12)
3. Ir para aba "Network"
4. Filtrar por "railway"
5. Recarregar pÃ¡gina (Ctrl+R)
6. Verificar se hÃ¡ requisiÃ§Ãµes para \`nc201746529.up.railway.app\`
7. Se houver, inspecionar payload enviado

**EvidÃªncia:** Fazer screenshot da requisiÃ§Ã£o (se encontrada)

## Arquivos de EvidÃªncia

Todos os outputs foram salvos em: \`$OUTPUT_DIR/\`

## PrÃ³ximos Passos

1. Revisar manualmente todos os arquivos .txt gerados
2. Executar teste manual do plugin (2.2)
3. Preencher coluna "Status" da tabela acima
4. Gerar relatÃ³rio executivo para o cliente

EOF

cat "$OUTPUT_DIR/RELATORIO_RESUMO.md"

echo -e "\n${GREEN}=================================${NC}"
echo -e "${GREEN}RETESTE CONCLUÃDO!${NC}"
echo -e "${GREEN}=================================${NC}"
echo -e "\nResultados salvos em: ${BLUE}$OUTPUT_DIR${NC}"
echo -e "RelatÃ³rio resumido: ${BLUE}$OUTPUT_DIR/RELATORIO_RESUMO.md${NC}"
echo -e "Log de execuÃ§Ã£o: ${BLUE}$LOG_FILE${NC}\n"
