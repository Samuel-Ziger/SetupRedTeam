#!/bin/bash

################################################################################
# SCRIPT DE RETESTE - Pentesting
# Data: 28/11/2025
# Analista: Samuel Ziger
# Objetivo: Validação de boas práticas de segurança (baseline já bom)
################################################################################

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Solicitar informações do alvo
echo -e "${BLUE}=================================${NC}"
echo -e "${BLUE}SCRIPT DE RETESTE - Pentesting${NC}"
echo -e "${BLUE}=================================${NC}\n"

read -p "Digite o domínio principal (ex: exemplo.com.br): " TARGET
read -p "Digite o domínio LP/secundário (ex: lp.exemplo.com.br, ou Enter para usar mesmo): " TARGET_LP
read -p "Digite o IP do domínio principal (opcional): " TARGET_IP
read -p "Digite o IP do domínio LP (opcional): " TARGET_IP_LP

if [ -z "$TARGET" ]; then
    echo -e "${RED}[ERRO] Domínio principal é obrigatório!${NC}"
    exit 1
fi

[ -z "$TARGET_LP" ] && TARGET_LP="$TARGET"
[ -z "$TARGET_IP_LP" ] && TARGET_IP_LP="$TARGET_IP"

echo -e "\n${GREEN}Domínio Principal: $TARGET${NC}"
echo -e "${GREEN}Domínio LP: $TARGET_LP${NC}"
[ ! -z "$TARGET_IP" ] && echo -e "${GREEN}IP Principal: $TARGET_IP${NC}"
[ ! -z "$TARGET_IP_LP" ] && echo -e "${GREEN}IP LP: $TARGET_IP_LP${NC}"
echo ""

# Configurações
OUTPUT_DIR="./resultados_${TARGET//./_}_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$OUTPUT_DIR"

# Log de execução
LOG_FILE="$OUTPUT_DIR/execution.log"
exec > >(tee -a "$LOG_FILE") 2>&1

echo -e "${BLUE}=================================${NC}"
echo -e "${BLUE}RETESTE: $TARGET${NC}"
echo -e "${BLUE}Data: $(date)${NC}"
echo -e "${BLUE}=================================${NC}\n"

################################################################################
# FUNÇÃO: Banner de seção
################################################################################
print_section() {
    echo -e "\n${GREEN}[$(date +%H:%M:%S)] ========== $1 ==========${NC}\n"
}

################################################################################
# NOTA: Este alvo teve EXCELENTE configuração TLS no relatório original
# Vamos validar se mantém o padrão
################################################################################

################################################################################
# TESTE 5.1: Configuração SSL/TLS (VALIDAÇÃO)
################################################################################
print_section "TESTE 5.1: Validando Configuração SSL/TLS Exemplar"

echo "# Testando protocolos TLS em ${TARGET_LP}..."

echo -e "\n## TLS 1.0 (deve estar desabilitado)..."
timeout 10 openssl s_client -connect "${TARGET_LP}:443" -tls1 2>&1 | tee "$OUTPUT_DIR/5.1_tls10.txt" | grep -i "protocol\|alert\|error"

if grep -qi "alert\|error\|handshake failure" "$OUTPUT_DIR/5.1_tls10.txt"; then
    echo -e "${GREEN}[✓] TLS 1.0 desabilitado${NC}"
else
    echo -e "${RED}[✗] TLS 1.0 ainda ativo${NC}"
fi

echo -e "\n## TLS 1.1 (deve estar desabilitado)..."
timeout 10 openssl s_client -connect "${TARGET_LP}:443" -tls1_1 2>&1 | tee "$OUTPUT_DIR/5.1_tls11.txt" | grep -i "protocol\|alert\|error"

if grep -qi "alert\|error\|handshake failure" "$OUTPUT_DIR/5.1_tls11.txt"; then
    echo -e "${GREEN}[✓] TLS 1.1 desabilitado${NC}"
else
    echo -e "${RED}[✗] TLS 1.1 ainda ativo${NC}"
fi

echo -e "\n## TLS 1.2 (deve estar ativo)..."
timeout 10 openssl s_client -connect "${TARGET_LP}:443" -tls1_2 2>&1 | tee "$OUTPUT_DIR/5.1_tls12.txt" | grep -i "protocol"

if grep -qi "TLSv1.2" "$OUTPUT_DIR/5.1_tls12.txt"; then
    echo -e "${GREEN}[✓] TLS 1.2 ativo${NC}"
else
    echo -e "${YELLOW}[~] TLS 1.2 pode estar desabilitado${NC}"
fi

echo -e "\n## TLS 1.3 (preferencial)..."
timeout 10 openssl s_client -connect "${TARGET_LP}:443" -tls1_3 2>&1 | tee "$OUTPUT_DIR/5.1_tls13.txt" | grep -i "protocol"

if grep -qi "TLSv1.3" "$OUTPUT_DIR/5.1_tls13.txt"; then
    echo -e "${GREEN}[✓] TLS 1.3 ativo (excelente!)${NC}"
else
    echo -e "${YELLOW}[i] TLS 1.3 não suportado (opcional, mas recomendado)${NC}"
fi

################################################################################
# TESTE 5.2: Certificado SSL (Let's Encrypt)
################################################################################
print_section "TESTE 5.2: Verificando Certificado SSL"

echo "# Obtendo informações do certificado..."
echo | openssl s_client -connect "${TARGET_LP}:443" -servername "${TARGET_LP}" 2>/dev/null | \
    openssl x509 -noout -text > "$OUTPUT_DIR/5.2_certificate.txt"

echo "## Emissor:"
grep "Issuer:" "$OUTPUT_DIR/5.2_certificate.txt"

echo -e "\n## Subject/CN:"
grep "Subject:" "$OUTPUT_DIR/5.2_certificate.txt"

echo -e "\n## Validade:"
echo | openssl s_client -connect "${TARGET_LP}:443" -servername "${TARGET_LP}" 2>/dev/null | \
    openssl x509 -noout -dates | tee "$OUTPUT_DIR/5.2_cert_dates.txt"

# Verificar se está expirado
EXPIRY=$(echo | openssl s_client -connect "${TARGET_LP}:443" -servername "${TARGET_LP}" 2>/dev/null | \
    openssl x509 -noout -enddate | cut -d= -f2)

EXPIRY_EPOCH=$(date -d "$EXPIRY" +%s 2>/dev/null || date -j -f "%b %d %H:%M:%S %Y %Z" "$EXPIRY" +%s 2>/dev/null)
NOW_EPOCH=$(date +%s)

if [ $EXPIRY_EPOCH -gt $NOW_EPOCH ]; then
    DAYS_LEFT=$(( ($EXPIRY_EPOCH - $NOW_EPOCH) / 86400 ))
    echo -e "${GREEN}[✓] Certificado válido (expira em $DAYS_LEFT dias)${NC}"
else
    echo -e "${RED}[✗] Certificado EXPIRADO!${NC}"
fi

echo -e "\n## SAN (Subject Alternative Names):"
openssl s_client -connect "${TARGET_LP}:443" -servername "${TARGET_LP}" 2>/dev/null | \
    openssl x509 -noout -text | grep -A1 "Subject Alternative Name"

################################################################################
# TESTE 5.3: Headers de Segurança
################################################################################
print_section "TESTE 5.3: Verificando Headers de Segurança HTTP"

echo "# Capturando headers de ${TARGET_LP}..."
curl -I "https://${TARGET_LP}/" 2>&1 | tee "$OUTPUT_DIR/5.3_headers.txt"

echo -e "\n## Análise de Headers:"

# HSTS
if grep -qi "strict-transport-security" "$OUTPUT_DIR/5.3_headers.txt"; then
    HSTS=$(grep -i "strict-transport-security" "$OUTPUT_DIR/5.3_headers.txt")
    echo -e "${GREEN}[✓] HSTS: $HSTS${NC}"
    
    # Verificar max-age
    if echo "$HSTS" | grep -q "max-age=31536000"; then
        echo -e "${GREEN}  └─ max-age adequado (1 ano)${NC}"
    fi
else
    echo -e "${RED}[✗] HSTS AUSENTE${NC}"
fi

# X-Frame-Options
if grep -qi "x-frame-options" "$OUTPUT_DIR/5.3_headers.txt"; then
    XFO=$(grep -i "x-frame-options" "$OUTPUT_DIR/5.3_headers.txt")
    echo -e "${GREEN}[✓] X-Frame-Options: $XFO${NC}"
else
    echo -e "${RED}[✗] X-Frame-Options AUSENTE${NC}"
fi

# X-XSS-Protection
if grep -qi "x-xss-protection" "$OUTPUT_DIR/5.3_headers.txt"; then
    XXSS=$(grep -i "x-xss-protection" "$OUTPUT_DIR/5.3_headers.txt")
    echo -e "${GREEN}[✓] X-XSS-Protection: $XXSS${NC}"
else
    echo -e "${YELLOW}[~] X-XSS-Protection ausente (deprecated, mas bom ter)${NC}"
fi

# X-Content-Type-Options
if grep -qi "x-content-type-options" "$OUTPUT_DIR/5.3_headers.txt"; then
    XCTO=$(grep -i "x-content-type-options" "$OUTPUT_DIR/5.3_headers.txt")
    echo -e "${GREEN}[✓] X-Content-Type-Options: $XCTO${NC}"
else
    echo -e "${RED}[✗] X-Content-Type-Options AUSENTE${NC}"
fi

# Referrer-Policy
if grep -qi "referrer-policy" "$OUTPUT_DIR/5.3_headers.txt"; then
    REFPOL=$(grep -i "referrer-policy" "$OUTPUT_DIR/5.3_headers.txt")
    echo -e "${GREEN}[✓] Referrer-Policy: $REFPOL${NC}"
else
    echo -e "${YELLOW}[~] Referrer-Policy ausente${NC}"
fi

# CSP
if grep -qi "content-security-policy:" "$OUTPUT_DIR/5.3_headers.txt"; then
    echo -e "${GREEN}[✓] Content-Security-Policy presente${NC}"
    grep -i "content-security-policy:" "$OUTPUT_DIR/5.3_headers.txt"
else
    echo -e "${YELLOW}[~] Content-Security-Policy ausente${NC}"
fi

################################################################################
# TESTE 5.4: Verificar Next.js e Headers Específicos
################################################################################
print_section "TESTE 5.4: Verificando Tecnologia Next.js"

echo "# Buscando headers Next.js..."
grep -iE "x-nextjs|x-vercel" "$OUTPUT_DIR/5.3_headers.txt" > "$OUTPUT_DIR/5.4_nextjs_headers.txt"

if [ -s "$OUTPUT_DIR/5.4_nextjs_headers.txt" ]; then
    echo -e "${BLUE}[INFO] Headers Next.js encontrados:${NC}"
    cat "$OUTPUT_DIR/5.4_nextjs_headers.txt"
else
    echo -e "${GREEN}[OK] Nenhum header Next.js exposto (bom para ofuscação)${NC}"
fi

# Verificar X-Powered-By
if grep -qi "x-powered-by" "$OUTPUT_DIR/5.3_headers.txt"; then
    POWERED=$(grep -i "x-powered-by" "$OUTPUT_DIR/5.3_headers.txt")
    echo -e "${YELLOW}[~] X-Powered-By exposto: $POWERED${NC}"
else
    echo -e "${GREEN}[✓] X-Powered-By removido/oculto${NC}"
fi

################################################################################
# TESTE 5.5: Scan de Portas (Verificação Geral)
################################################################################
print_section "TESTE 5.5: Verificação de Portas Abertas"

echo "# Executando Nmap em ${TARGET_IP} (planodechamadas.com.br)..."
nmap -sV -p 22,80,443,3000,8080 "$TARGET_IP" -oN "$OUTPUT_DIR/5.5_nmap_planodechamadas.txt"

cat "$OUTPUT_DIR/5.5_nmap_planodechamadas.txt"

echo -e "\n# Executando Nmap em ${TARGET_IP_LP} (lp.planodechamadas.com.br)..."
nmap -sV -p 22,80,443,3000,8080 "$TARGET_IP_LP" -oN "$OUTPUT_DIR/5.5_nmap_lp.txt"

cat "$OUTPUT_DIR/5.5_nmap_lp.txt"

echo -e "\n## Análise:"
OPEN_PORTS=$(grep "open" "$OUTPUT_DIR/5.5_nmap_"*.txt | grep -v "80/tcp\|443/tcp" | wc -l)

if [ $OPEN_PORTS -eq 0 ]; then
    echo -e "${GREEN}[✓] Apenas portas 80/443 abertas (configuração ideal)${NC}"
else
    echo -e "${YELLOW}[~] Portas adicionais abertas (revisar necessidade):${NC}"
    grep "open" "$OUTPUT_DIR/5.5_nmap_"*.txt | grep -v "80/tcp\|443/tcp"
fi

################################################################################
# TESTE 5.6: Teste de Redirecionamento HTTP → HTTPS
################################################################################
print_section "TESTE 5.6: Validando Redirecionamento HTTP → HTTPS"

echo "# Testando HTTP (porta 80) - deve redirecionar para HTTPS..."
curl -I "http://${TARGET_LP}/" 2>&1 | tee "$OUTPUT_DIR/5.6_http_redirect.txt" | head -10

if grep -q "301\|302" "$OUTPUT_DIR/5.6_http_redirect.txt" && grep -qi "location.*https" "$OUTPUT_DIR/5.6_http_redirect.txt"; then
    echo -e "${GREEN}[✓] Redirecionamento HTTP → HTTPS ativo${NC}"
else
    echo -e "${YELLOW}[~] Redirecionamento HTTP → HTTPS não detectado${NC}"
fi

################################################################################
# RELATÓRIO FINAL
################################################################################
print_section "RELATÓRIO CONSOLIDADO"

cat > "$OUTPUT_DIR/RELATORIO_RESUMO.md" << EOF
# Relatório de Reteste - $TARGET
**Data:** $(date)
**Analista:** Samuel Ziger
**Domínio Principal:** $TARGET
**Domínio LP:** $TARGET_LP
**IP Principal:** ${TARGET_IP:-N/A}
**IP LP:** ${TARGET_IP_LP:-N/A}

## Resumo Executivo

**Status Geral:** Este alvo apresentou configuração SSL/TLS exemplar no relatório original (Nota A+).
O reteste visa confirmar manutenção do padrão de segurança.

## Verificações Realizadas

| # | Aspecto | Status Esperado | Status Atual | Observações |
|---|---------|-----------------|--------------|-------------|
| 5.1 | Protocolos TLS | TLS 1.2/1.3 apenas | [ ] | Ver 5.1_*.txt |
| 5.2 | Certificado SSL | Let's Encrypt válido | [ ] | Ver 5.2_*.txt |
| 5.3 | Headers de Segurança | HSTS, XFO, XCTO, etc | [ ] | Ver 5.3_*.txt |
| 5.4 | Ofuscação de Stack | Headers Next.js ocultos | [ ] | Ver 5.4_*.txt |
| 5.5 | Superfície de Ataque | Apenas 80/443 | [ ] | Ver 5.5_*.txt |
| 5.6 | Redirect HTTP→HTTPS | Ativo | [ ] | Ver 5.6_*.txt |

## Configuração TLS Esperada (Baseline)

### Protocolos
- ✅ TLS 1.2 ativo
- ✅ TLS 1.3 ativo
- ❌ TLS 1.0 desabilitado
- ❌ TLS 1.1 desabilitado

### Cipher Suites (Esperado)
- AES-GCM
- CHACHA20-POLY1305
- ECDHE (Perfect Forward Secrecy)

### Headers de Segurança (Baseline)
- Strict-Transport-Security: max-age=31536000
- X-Frame-Options: SAMEORIGIN
- X-XSS-Protection: 1; mode=block
- X-Content-Type-Options: nosniff
- Referrer-Policy: no-referrer-when-downgrade
- Content-Security-Policy: (adequado)

## Domínios/IPs Testados

- **planodechamadas.com.br:** $TARGET_IP
- **lp.planodechamadas.com.br:** $TARGET_IP_LP

## Certificado SSL

- **Emissor:** Let's Encrypt (CA "E7" no original)
- **Tipo:** ECDSA 256 bits
- **Validade:** [Ver 5.2_cert_dates.txt]
- **SAN:** [Ver 5.2_certificate.txt]

## Observações

Este alvo serve como **referência de boas práticas** para os demais.
A configuração original recebeu **Nota A+** em todos os aspectos de TLS/SSL.

## Arquivos de Evidência

Todos os outputs foram salvos em: \`$OUTPUT_DIR/\`

## Próximos Passos

1. Revisar todos os arquivos .txt gerados
2. Comparar com baseline do relatório original (08/10/2025)
3. Preencher coluna "Status Atual" da tabela
4. Se houver degradação, documentar e alertar cliente

## Checklist de Validação

- [ ] TLS 1.0/1.1 desabilitados
- [ ] TLS 1.2/1.3 ativos
- [ ] Certificado válido e não próximo de expiração (>30 dias)
- [ ] HSTS presente com max-age adequado
- [ ] Headers de segurança presentes
- [ ] Apenas portas 80/443 abertas
- [ ] Redirecionamento HTTP→HTTPS ativo

EOF

cat "$OUTPUT_DIR/RELATORIO_RESUMO.md"

echo -e "\n${GREEN}=================================${NC}"
echo -e "${GREEN}RETESTE CONCLUÍDO!${NC}"
echo -e "${GREEN}=================================${NC}"
echo -e "\nResultados salvos em: ${BLUE}$OUTPUT_DIR${NC}"
echo -e "Relatório resumido: ${BLUE}$OUTPUT_DIR/RELATORIO_RESUMO.md${NC}"
echo -e "Log de execução: ${BLUE}$LOG_FILE${NC}\n"

echo -e "${BLUE}[INFO] Este alvo possui configuração exemplar.${NC}"
echo -e "${BLUE}Use-o como referência para hardening dos demais alvos.${NC}\n"
