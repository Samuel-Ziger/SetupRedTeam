name: Reteste Automatizado Semanal

on:
  schedule:
    # Executar todo domingo Ã s 2h da manhÃ£ (UTC)
    - cron: '0 2 * * 0'
  
  # Permitir execuÃ§Ã£o manual
  workflow_dispatch:
    inputs:
      target:
        description: 'Alvo especÃ­fico (ou deixe vazio para todos)'
        required: false
        default: ''

jobs:
  reteste:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v3
      
      - name: ðŸ”§ Setup ambiente
        run: |
          sudo apt-get update
          sudo apt-get install -y curl netcat-openbsd openssl
      
      - name: ðŸ” Verificar secrets
        run: |
          if [ -z "${{ secrets.DISCORD_WEBHOOK }}" ]; then
            echo "âš ï¸ DISCORD_WEBHOOK nÃ£o configurado"
          fi
          if [ -z "${{ secrets.SLACK_WEBHOOK }}" ]; then
            echo "âš ï¸ SLACK_WEBHOOK nÃ£o configurado"
          fi
      
      - name: ðŸŽ¯ Executar retestes
        id: run_tests
        run: |
          cd ScrpitPentestSH/retestesh
          chmod +x executar_todos_retestes.sh
          
          if [ -n "${{ github.event.inputs.target }}" ]; then
            # Executar apenas target especÃ­fico
            ./reteste_${{ github.event.inputs.target }}.sh
          else
            # Executar todos
            ./executar_todos_retestes.sh
          fi
          
          # Salvar nome do relatÃ³rio
          REPORT=$(ls -t relatorio_reteste_completo_*.txt | head -1)
          echo "report_file=$REPORT" >> $GITHUB_OUTPUT
      
      - name: ðŸ“Š Analisar resultados
        id: analyze
        run: |
          REPORT="${{ steps.run_tests.outputs.report_file }}"
          
          # Contar vulnerabilidades por status
          CRITICAS=$(grep -c "ðŸ”´" "$REPORT" || echo "0")
          MEDIAS=$(grep -c "ðŸŸ¡" "$REPORT" || echo "0")
          CORRIGIDAS=$(grep -c "ðŸŸ¢" "$REPORT" || echo "0")
          
          echo "criticas=$CRITICAS" >> $GITHUB_OUTPUT
          echo "medias=$MEDIAS" >> $GITHUB_OUTPUT
          echo "corrigidas=$CORRIGIDAS" >> $GITHUB_OUTPUT
          
          # Determinar status geral
          if [ $CRITICAS -gt 0 ]; then
            echo "status=ðŸ”´ CRÃTICO" >> $GITHUB_OUTPUT
            echo "color=15158332" >> $GITHUB_OUTPUT  # Vermelho
          elif [ $MEDIAS -gt 5 ]; then
            echo "status=ðŸŸ¡ ATENÃ‡ÃƒO" >> $GITHUB_OUTPUT
            echo "color=16776960" >> $GITHUB_OUTPUT  # Amarelo
          else
            echo "status=ðŸŸ¢ OK" >> $GITHUB_OUTPUT
            echo "color=3066993" >> $GITHUB_OUTPUT   # Verde
          fi
      
      - name: ðŸ“¤ Upload relatÃ³rio como artifact
        uses: actions/upload-artifact@v3
        with:
          name: relatorio-reteste-${{ github.run_number }}
          path: ScrpitPentestSH/retestesh/relatorio_*.txt
          retention-days: 90
      
      - name: ðŸ”” NotificaÃ§Ã£o Discord
        if: ${{ secrets.DISCORD_WEBHOOK != '' }}
        run: |
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"Reteste Automatizado - ${{ steps.analyze.outputs.status }}\",
                \"description\": \"Resultados do reteste semanal\",
                \"color\": ${{ steps.analyze.outputs.color }},
                \"fields\": [
                  {
                    \"name\": \"ðŸ”´ CrÃ­ticas\",
                    \"value\": \"${{ steps.analyze.outputs.criticas }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"ðŸŸ¡ MÃ©dias\",
                    \"value\": \"${{ steps.analyze.outputs.medias }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"ðŸŸ¢ Corrigidas\",
                    \"value\": \"${{ steps.analyze.outputs.corrigidas }}\",
                    \"inline\": true
                  }
                ],
                \"footer\": {
                  \"text\": \"GitHub Actions - $(date)\"
                }
              }]
            }" \
            ${{ secrets.DISCORD_WEBHOOK }}
      
      - name: ðŸ”” NotificaÃ§Ã£o Slack
        if: ${{ secrets.SLACK_WEBHOOK != '' }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"Reteste Automatizado - ${{ steps.analyze.outputs.status }}\",
              \"attachments\": [{
                \"color\": \"${{ steps.analyze.outputs.status == 'ðŸ”´ CRÃTICO' && 'danger' || steps.analyze.outputs.status == 'ðŸŸ¡ ATENÃ‡ÃƒO' && 'warning' || 'good' }}\",
                \"fields\": [
                  {
                    \"title\": \"CrÃ­ticas\",
                    \"value\": \"${{ steps.analyze.outputs.criticas }}\",
                    \"short\": true
                  },
                  {
                    \"title\": \"MÃ©dias\",
                    \"value\": \"${{ steps.analyze.outputs.medias }}\",
                    \"short\": true
                  },
                  {
                    \"title\": \"Corrigidas\",
                    \"value\": \"${{ steps.analyze.outputs.corrigidas }}\",
                    \"short\": true
                  }
                ]
              }]
            }" \
            ${{ secrets.SLACK_WEBHOOK }}
      
      - name: âœ… Resumo
        run: |
          echo "## ðŸ“Š Resumo do Reteste" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.analyze.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Categoria | Quantidade |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”´ CrÃ­ticas | ${{ steps.analyze.outputs.criticas }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¡ MÃ©dias | ${{ steps.analyze.outputs.medias }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¢ Corrigidas | ${{ steps.analyze.outputs.corrigidas }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ RelatÃ³rio completo disponÃ­vel nos artifacts deste workflow." >> $GITHUB_STEP_SUMMARY
